# sneaker_manager/app/ui.pyfrom PIL import Image, ImageTkimport osimport customtkinter as ctkfrom tkinter import filedialog, messageboxfrom PIL import Imagefrom .services import SneakerServicefrom .utils import resize_image, open_image_previewfrom datetime import datetimeclass SneakerApp(ctk.CTk):    def __init__(self):        super().__init__()        self.title("Sneaker Manager v0.2")        self.geometry("1100x700")        # 初始化图像资源        self._load_images()        # 配置布局        self.grid_rowconfigure(0, weight=1)        self.grid_columnconfigure(1, weight=1)        # 创建导航栏        self._create_navigation()        # 创建各功能框架        self._create_home_frame()        self._create_management_frame()        self._create_stats_frame()        self._create_settings_frame()        self._create_search_widgets()        # 默认显示管理界面        self.select_frame_by_name("home")    def _load_images(self):        """加载所有图像资源"""        image_path = os.path.join(os.path.dirname(__file__), "assets")        # 导航图标        self.nav_images = {            "home": ctk.CTkImage(                light_image=Image.open(os.path.join(image_path, "home_light.png")),                dark_image=Image.open(os.path.join(image_path, "home_dark.png")),                size=(24, 24)),            "management": ctk.CTkImage(                light_image=Image.open(os.path.join(image_path, "sneaker_light.png")),                dark_image=Image.open(os.path.join(image_path, "sneaker_dark.png")),                size=(24, 24)),            "stats": ctk.CTkImage(                light_image=Image.open(os.path.join(image_path, "chart_light.png")),                dark_image=Image.open(os.path.join(image_path, "chart_dark.png")),                size=(24, 24)),            "settings": ctk.CTkImage(                light_image=Image.open(os.path.join(image_path, "settings_light.png")),                dark_image=Image.open(os.path.join(image_path, "settings_dark.png")),                size=(24, 24))        }        # 其他图像        self.logo_image = ctk.CTkImage(            Image.open(os.path.join(image_path, "logo.png")),            size=(40, 40))    def _create_navigation(self):        """创建左侧导航栏"""        self.navigation_frame = ctk.CTkFrame(self, corner_radius=0, width=200)        self.navigation_frame.grid(row=0, column=0, sticky="nsew")        self.navigation_frame.grid_rowconfigure(5, weight=1)        # 应用Logo        ctk.CTkLabel(            self.navigation_frame,            text=" SNEAKER\n MANAGER",            image=self.logo_image,            compound="left",            font=ctk.CTkFont(family="Arial", size=16, weight="bold")        ).grid(row=0, column=0, padx=15, pady=30)        # 导航按钮        nav_buttons = [            ("home", "概览主页", self.home_button_event),            ("management", "球鞋管理", self.management_button_event),            ("stats", "数据统计", self.stats_button_event),            ("settings","设置",self.settings_button_event)        ]        for idx, (name, text, command) in enumerate(nav_buttons, 1):            btn = ctk.CTkButton(                self.navigation_frame,                corner_radius=0,                height=45,                text=text,                image=self.nav_images[name],                anchor="w",                command=command,                fg_color="transparent",                text_color=("gray10", "gray90"),                hover_color=("gray70", "gray30")            )            btn.grid(row=idx, column=0, sticky="ew", padx=10)        # 主题切换        ctk.CTkLabel(self.navigation_frame, text="界面主题:").grid(row=6, column=0, pady=(20, 5))        self.appearance_menu = ctk.CTkOptionMenu(            self.navigation_frame,            values=["System", "Light", "Dark"],            command=self._change_appearance_mode        )        self.appearance_menu.grid(row=7, column=0, padx=10, pady=(0, 20))    def _create_home_frame(self):        """创建概览主页"""        self.home_frame = ctk.CTkFrame(self, corner_radius=0, fg_color="transparent")        # 添加统计卡片        stats_grid = ctk.CTkFrame(self.home_frame)        stats_grid.pack(pady=30, padx=20, fill="both")        stats = [            ("球鞋数量","2","#9AA5FC"),            ("品牌数量", "12", "#4CCEAC"),            ("总价值", "¥23,450", "#FFB476"),            ("最近购入", "2天前", "#9AA5FC"),            ("最喜爱的球鞋","AJ12","#FFB476")        ]        for idx, (title, value, color) in enumerate(stats):            card = ctk.CTkFrame(stats_grid, width=200, height=120)            card.grid(row=0, column=idx, padx=15)            ctk.CTkLabel(card, text=title, font=("微软雅黑", 14)).pack(pady=(15, 5))            ctk.CTkLabel(card, text=value, font=("微软雅黑", 24, "bold"), text_color=color).pack()    def _create_management_frame(self):        """创建核心管理界面"""        self.management_frame = ctk.CTkFrame(self, corner_radius=0, fg_color="transparent")        # 输入表单区域        input_frame = ctk.CTkFrame(self.management_frame)        input_frame.pack(pady=20, padx=20, fill="x")        # 输入字段        self.entries = {}        fields = [            ("name", "球鞋名称"),            ("brand", "品牌"),            ("series", "系列"),            ("size", "鞋码"),            ("price", "购买价格"),            ("date", "购买日期"),            ("color","颜色")        ]        for idx, (field, label) in enumerate(fields):            fields_per_row = 3            row = idx // fields_per_row            col = idx % fields_per_row * 2            ctk.CTkLabel(input_frame, text=label).grid(row=row, column=col, padx=5, pady=5)            entry = ctk.CTkEntry(input_frame, width=120)            entry.grid(row=row, column=col + 1, padx=5, pady=5)            self.entries[field] = entry        # 操作按钮        btn_frame = ctk.CTkFrame(input_frame)        btn_frame.grid(row=4, column=2, columnspan=4, pady=10)        ctk.CTkButton(btn_frame, text="上传图片", command=self._handle_upload).pack(side="left", padx=5)        ctk.CTkButton(btn_frame, text="添加记录", command=self._add_sneaker).pack(side="left", padx=5)        ctk.CTkButton(btn_frame, text="清空表单", command=self._clear_form).pack(side="left", padx=5)        # 数据列表        self.list_frame = ctk.CTkScrollableFrame(            self.management_frame,            width=800,            height=400        )        self.list_frame.pack(pady=20, padx=20, fill="both", expand=True)        self._load_list()    def _create_stats_frame(self):        """创建统计页面"""        self.stats_frame = ctk.CTkFrame(self, corner_radius=0, fg_color="transparent")        ctk.CTkLabel(self.stats_frame, text="数据统计模块开发中...", font=("微软雅黑", 16)).pack(pady=50)    def _create_settings_frame(self):        """创建设置页面"""        self.settings_frame = ctk.CTkFrame(self, corner_radius=0, fg_color="transparent")        ctk.CTkLabel(self.settings_frame, text="设置页面开发中...", font=("微软雅黑", 16)).pack(pady=50)    def select_frame_by_name(self, name):        """切换显示框架"""        self.home_frame.grid_forget()        self.management_frame.grid_forget()        self.stats_frame.grid_forget()        self.settings_frame.grid_forget()        if name == "home":            self.home_frame.grid(row=0, column=1, sticky="nsew")        elif name == "management":            self.management_frame.grid(row=0, column=1, sticky="nsew")        elif name == "stats":            self.stats_frame.grid(row=0, column=1, sticky="nsew")        elif name == "settings":            self.settings_frame.grid(row=0, column=1, sticky="nsew")    def _handle_upload(self):        """处理图片上传"""        path = filedialog.askopenfilename(            filetypes=[("Image Files", "*.png;*.jpg;*.jpeg")]        )        if path:            try:                # 将图片复制到应用目录                target_dir = os.path.join(os.path.dirname(__file__), "uploads")                os.makedirs(target_dir, exist_ok=True)                filename = f"{datetime.now().strftime('%Y%m%d%H%M%S')}.{path.split('.')[-1]}"                target_path = os.path.join(target_dir, filename)                with Image.open(path) as img:                    img.save(target_path)                self.image_path = target_path                messagebox.showinfo("上传成功", "图片已保存")            except Exception as e:                messagebox.showerror("上传失败", str(e))    def _add_sneaker(self):        """添加新球鞋"""        try:            # 数据验证            required_fields = ["name", "brand", "price", "date"]            for field in required_fields:                if not self.entries[field].get().strip():                    raise ValueError(f"{field} 字段不能为空")            sneaker_data = dict(name=self.entries["name"].get(), brand=self.entries["brand"].get(),                                series=self.entries["series"].get(),                                size=float(self.entries["size"].get()) if self.entries["size"].get() else None,                                purchase_price=float(self.entries["price"].get()),                                purchase_date=self._validate_date(self.entries["date"].get()),                                image_path=self.image_path, color=self.entries["color"].get())            # 调用服务层            SneakerService.create_sneaker(sneaker_data)            # 重置界面            self._clear_form()            self._load_list()            messagebox.showinfo("成功", "球鞋已添加")        except ValueError as e:            messagebox.showerror("输入错误", str(e))        except Exception as e:            messagebox.showerror("系统错误", f"保存失败: {str(e)}")    def _load_list(self, sneakers=None):        """加载/刷新球鞋列表"""        # 清空旧内容        for widget in self.list_frame.winfo_children():            widget.destroy()        # 获取数据        if sneakers is None:            sneakers = SneakerService.get_all_sneakers()        # 创建卡片        for sneaker in sneakers:            self._create_sneaker_card(sneaker)    def _create_sneaker_card(self, sneaker):        """创建单个球鞋卡片"""        card = ctk.CTkFrame(self.list_frame)        card.pack(fill="x", pady=5, padx=10)        # 图片显示        img_frame = ctk.CTkFrame(card, width=100)        img_frame.pack(side="left", fill="y")        if sneaker.image_path and os.path.exists(sneaker.image_path):            img = resize_image(sneaker.image_path, (80, 80))            img_label = ctk.CTkLabel(img_frame, image=img, text="")            img_label.image = img            img_label.pack(padx=5)            img_label.bind("<Button-1>", lambda e, p=sneaker.image_path: open_image_preview(p))        else:            ctk.CTkLabel(img_frame, text="[无图]", width=80).pack(pady=10)        # 信息显示        info_frame = ctk.CTkFrame(card)        info_frame.pack(side="left", fill="both", expand=True, padx=10)        info_text = (            f"名称：{sneaker.name}\n"            f"品牌：{sneaker.brand} | 系列：{sneaker.series}\n"            f"鞋码：{sneaker.size or '未填写'} | 颜色：{sneaker.color}\n"            f"购入日期：{sneaker.purchase_date} | 价格：¥{sneaker.purchase_price:.2f}\n"        )        ctk.CTkLabel(info_frame, text=info_text, anchor="w").pack(fill="x")        # 操作按钮        btn_frame = ctk.CTkFrame(card)        btn_frame.pack(side="right", padx=10)        ctk.CTkButton(            btn_frame,            text="编辑",            width=80,            command=lambda s=sneaker: self._open_edit_dialog(s)        ).pack(side="left", padx=5)        ctk.CTkButton(            btn_frame,            text="删除",            width=80,            fg_color="#dc3545",            hover_color="#bb2d3b",            command=lambda s=sneaker.id: self._delete_sneaker(s)        ).pack(side="left", padx=5)    def _open_edit_dialog(self, sneaker):        """打开编辑对话框（修复保存按钮问题）"""        dialog = ctk.CTkToplevel(self)        dialog.title(f"编辑 - {sneaker.name}")        dialog.geometry("500x650")  # 增加窗口高度        dialog.grab_set()        # 使用网格布局管理器        dialog.grid_columnconfigure(1, weight=1)        # ===== 输入字段 =====        entries = {}        fields = [            ("name", "球鞋名称", sneaker.name),            ("brand", "品牌", sneaker.brand),            ("series", "系列", sneaker.series),            ("size", "鞋码", sneaker.size),            ("price", "购买价格", sneaker.purchase_price),            ("date", "购买日期", sneaker.purchase_date),            #("color","颜色",sneaker.color),        ]        for row, (field, label, value) in enumerate(fields):            # 标签            ctk.CTkLabel(dialog, text=label).grid(                row=row, column=0, padx=10, pady=5, sticky="w"            )            # 输入框            entry = ctk.CTkEntry(dialog)            entry.insert(0, str(value) if value else "")            entry.grid(                row=row, column=1, padx=10, pady=5, sticky="ew"            )            entries[field] = entry        # ===== 图片预览 =====        img_frame = ctk.CTkFrame(dialog)        img_frame.grid(row=6, column=0, columnspan=2, pady=10, sticky="nsew")        if sneaker.image_path and os.path.exists(sneaker.image_path):            try:                img = resize_image(sneaker.image_path, (300, 300))                img_label = ctk.CTkLabel(img_frame, image=img, text="")                img_label.image = img  # 保持引用                img_label.pack()            except Exception as e:                ctk.CTkLabel(img_frame, text=f"图片加载失败: {str(e)}").pack()        else:            ctk.CTkLabel(img_frame, text="[无有效图片]").pack()        # ===== 按钮区域 =====        btn_frame = ctk.CTkFrame(dialog)        btn_frame.grid(row=7, column=0, columnspan=2, pady=15, sticky="ew")    def save_changes(self,sneaker):        try:            # 数据验证            if not self.entries["name"].get().strip():                raise ValueError("名称不能为空")            # 构建更新数据            update_data = {                "name": self.entries["name"].get(),                "brand": self.entries["brand"].get(),                "series": self.entries["series"].get(),                "size": float(self.entries["size"].get()) if self.entries["size"].get() else None,                "purchase_price": float(self.entries["price"].get()),                "purchase_date": self._validate_date(self.entries["date"].get())            }            # 调用服务层更新            SneakerService.update_sneaker(sneaker.id, update_data)            # 刷新列表并关闭对话框            self._load_list()            self.dialog.destroy()            messagebox.showinfo("成功", "修改已保存")        except ValueError as ve:            messagebox.showerror("输入错误", str(ve))        except Exception as e:            messagebox.showerror("保存失败", f"发生错误: {str(e)}")        # 按钮布局        ctk.CTkButton(self.btn_frame,        text="保存修改",        fg_color="#4CAF50",  # 绿色强调色        hover_color="#45A049",        command=self.save_changes).pack(side="left", padx=10)        ctk.CTkButton(self.btn_frame,        text="取消",        fg_color="#757575",  # 中性灰色        hover_color="#616161",        command=self.dialog.destroy).pack(side="right", padx=30)    def _delete_sneaker(self, sneaker_id):        """删除球鞋"""        if messagebox.askyesno("确认删除", "确定要删除这条记录吗？"):            try:                SneakerService.delete_sneaker(sneaker_id)                self._load_list()            except Exception as e:                messagebox.showerror("删除失败", str(e))    def _clear_form(self) -> object:        for entry in self.entries.values():            entry.delete(0, ctk.END)        self.image_path = None    @staticmethod    def _validate_date(date_str):        """验证日期格式"""        try:            datetime.strptime(date_str, "%Y-%m-%d")            return date_str        except ValueError:            raise ValueError("日期格式应为YYYY-MM-DD")    def _create_search_widgets(self):        """创建搜索相关组件"""        # 搜索框容器        search_frame = ctk.CTkFrame(self.management_frame)        search_frame.pack(pady=10, padx=20, fill="x")        # 实时搜索输入框        self.search_entry = ctk.CTkEntry(            search_frame,            placeholder_text="搜索球鞋（名称/品牌/系列）",            width=300        )        self.search_entry.pack(side="left", padx=(0, 10))        self.search_entry.bind("<KeyRelease>", self._on_search_input)        # 高级筛选按钮        self.advanced_filter_btn = ctk.CTkButton(            search_frame,            text="高级筛选 ▼",            command=self._toggle_advanced_filters        )        self.advanced_filter_btn.pack(side="right")        # 高级筛选面板（初始隐藏）        self.advanced_filter_frame = ctk.CTkFrame(self.management_frame)        # 品牌选择        ctk.CTkLabel(self.advanced_filter_frame, text="品牌：").grid(row=0, column=0, padx=5)        self.brand_combobox = ctk.CTkComboBox(            self.advanced_filter_frame,            values=["所有品牌", "Jordan", "Nike", "Adidas", "New Balance","Puma","李宁","安踏", "其他"]        )        self.brand_combobox.grid(row=0, column=1, padx=5)        # 价格范围        ctk.CTkLabel(self.advanced_filter_frame, text="价格范围：").grid(row=0, column=2, padx=5)        self.min_price_entry = ctk.CTkEntry(self.advanced_filter_frame, placeholder_text="最低价", width=100)        self.min_price_entry.grid(row=0, column=3, padx=5)        self.max_price_entry = ctk.CTkEntry(self.advanced_filter_frame, placeholder_text="最高价", width=100)        self.max_price_entry.grid(row=0, column=4, padx=5)        # 应用筛选按钮        ctk.CTkButton(            self.advanced_filter_frame,            text="应用筛选",            command=self._apply_advanced_filters        ).grid(row=0, column=5, padx=10)    def _on_search_input(self, event=None):        """实时搜索输入处理（带防抖）"""        if hasattr(self, "_search_job"):            self.after_cancel(self._search_job)        # 设置500ms防抖延迟        self._search_job = self.after(500, self._perform_search)    def _perform_search(self):        """执行搜索操作"""        try:            search_params = {                "keyword": self.search_entry.get().strip(),                "brand": self.brand_combobox.get() if self.brand_combobox.get() != "所有品牌" else None,                "min_price": self._validate_float(self.min_price_entry.get()),                "max_price": self._validate_float(self.max_price_entry.get())            }            # 调用服务层搜索            filtered = SneakerService.search_sneakers(**search_params)            self._load_list(filtered)        except ValueError as e:            messagebox.showerror("输入错误", str(e))    def _toggle_advanced_filters(self):        """切换高级筛选面板"""        if self.advanced_filter_frame.winfo_ismapped():            self.advanced_filter_frame.pack_forget()            self.advanced_filter_btn.configure(text="高级筛选 ▲")        else:            self.advanced_filter_frame.pack(pady=10, padx=20, fill="x")            self.advanced_filter_btn.configure(text="高级筛选 ▼")    def _apply_advanced_filters(self):        """应用高级筛选"""        self._perform_search()    @staticmethod    def _validate_float(value: str) -> float | None:        """验证浮点数字符串"""        try:            return float(value) if value else None        except ValueError:            raise ValueError("请输入有效的数字")    # 导航事件    def home_button_event(self):        self.select_frame_by_name("home")    def management_button_event(self):        self.select_frame_by_name("management")    def stats_button_event(self):        self.select_frame_by_name("stats")    def settings_button_event(self):        self.select_frame_by_name("settings")    def _change_appearance_mode(self, mode):        ctk.set_appearance_mode(mode)